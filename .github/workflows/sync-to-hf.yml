name: Sync to Hugging Face Space

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create deployment-only branch (exclude test data for HF Space)
        run: |
          # Create orphan branch with only deployment files (avoids LFS storage limits)
          git checkout --orphan hf-deploy-temp
          git rm -rf --cached . 2>/dev/null || true
          
          # Add core deployment files (ignore missing files)
          git add app.py app_settings.py helpers_mongo.py entrypoint.sh Dockerfile requirements.txt README.md .gitattributes .cursorrules .github/workflows/sync-to-hf.yml 2>/dev/null || true
          
          # Add new modular structure
          git add app/ pages/ 2>/dev/null || true
          
          # Add .streamlit/ if it exists
          if [ -d .streamlit ]; then
            git add .streamlit/
          fi
          
          # Verify files were added
          if [ -z "$(git ls-files --cached)" ]; then
            echo "Error: No files to commit"
            exit 1
          fi
          
          # Commit deployment files (allow empty commit if nothing changed but files are staged)
          git commit -m "chore: Sync deployment files to HF Space (excludes test data to stay within storage limits)" || \
          git commit --allow-empty -m "chore: Sync deployment files to HF Space (no changes detected)"

      - name: Add Hugging Face remote
        run: |
          git remote add huggingface https://huggingface.co/spaces/f007kht/osprey-experimental || true
          git remote set-url huggingface https://huggingface.co/spaces/f007kht/osprey-experimental

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.osprey_space_push }}
        run: |
          if [ -z "${HF_TOKEN}" ]; then
            echo "::error::HF_TOKEN environment variable is empty. Check that osprey_space_push secret is configured."
            echo ""
            echo "To configure:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: osprey_space_push (must use underscores, not hyphens)"
            echo "4. Value: Your Hugging Face token (starts with 'hf_')"
            echo "5. Click 'Add secret'"
            exit 1
          fi
          echo "Pushing to Hugging Face Space..."
          git push --force https://huggingface:${HF_TOKEN}@huggingface.co/spaces/f007kht/osprey-experimental hf-deploy-temp:main
          echo "âœ… Successfully pushed to Hugging Face Space"

