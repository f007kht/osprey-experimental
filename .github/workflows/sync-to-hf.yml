name: Sync to Hugging Face Space

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create deployment-only branch (exclude test data for HF Space)
        run: |
          # Create orphan branch with only deployment files (avoids LFS storage limits)
          git checkout --orphan hf-deploy-temp
          git rm -rf --cached . 2>/dev/null || true
          
          echo "=== Checking file existence ==="
          [ -f app.py ] && echo "✓ app.py" || echo "✗ app.py missing"
          [ -f app_settings.py ] && echo "✓ app_settings.py" || echo "✗ app_settings.py missing"
          [ -f helpers_mongo.py ] && echo "✓ helpers_mongo.py" || echo "✗ helpers_mongo.py missing"
          [ -f entrypoint.sh ] && echo "✓ entrypoint.sh" || echo "✗ entrypoint.sh missing"
          [ -f Dockerfile ] && echo "✓ Dockerfile" || echo "✗ Dockerfile missing"
          [ -f requirements.txt ] && echo "✓ requirements.txt" || echo "✗ requirements.txt missing"
          [ -f README.md ] && echo "✓ README.md" || echo "✗ README.md missing"
          [ -d app/ ] && echo "✓ app/" || echo "✗ app/ missing"
          [ -d pages/ ] && echo "✓ pages/" || echo "✗ pages/ missing"
          [ -d utils/ ] && echo "✓ utils/" || echo "✗ utils/ missing"
          [ -d scripts/ ] && echo "✓ scripts/" || echo "✗ scripts/ missing"
          [ -d .streamlit ] && echo "✓ .streamlit/" || echo "✗ .streamlit/ missing"
          
          echo ""
          echo "=== Adding core deployment files ==="
          # Add core deployment files one by one with error checking
          for file in app.py app_settings.py helpers_mongo.py entrypoint.sh Dockerfile requirements.txt README.md .gitattributes .cursorrules .github/workflows/sync-to-hf.yml; do
            if [ -f "$file" ]; then
              git add "$file" && echo "  Added: $file" || echo "  Failed: $file"
            else
              echo "  Skipped (missing): $file"
            fi
          done
          
          echo ""
          echo "=== Adding modular structure directories ==="
          # Add directories if they exist and have content
          for dir in app pages utils scripts; do
            if [ -d "$dir" ] && [ "$(ls -A $dir 2>/dev/null)" ]; then
              git add "$dir/" && echo "  Added: $dir/" || echo "  Failed: $dir/"
            else
              echo "  Skipped (missing or empty): $dir/"
            fi
          done
          
          # Always ensure .streamlit/ exists and is committed (force-add even if in .gitignore)
          echo "  Ensuring .streamlit/ directory exists..."
          mkdir -p .streamlit
          if [ ! -f .streamlit/config.toml ]; then
            echo "  Creating minimal .streamlit/config.toml..."
            {
              echo '[server]'
              echo 'headless = true'
              echo 'port = 8501'
              echo 'enableXsrfProtection = false'
              echo 'maxUploadSize = 200'
              echo 'enableCORS = false'
              echo 'fileWatcherType = "poll"'
              echo ''
              echo '[browser]'
              echo 'gatherUsageStats = false'
              echo 'serverAddress = "localhost"'
            } > .streamlit/config.toml
          fi
          # Force-add .streamlit/ even if it's in .gitignore
          git add -f .streamlit/ && echo "  Added: .streamlit/" || echo "  Failed: .streamlit/"
          
          echo ""
          echo "=== Verifying staged files ==="
          STAGED_FILES=$(git ls-files --cached)
          STAGED_COUNT=$(echo "$STAGED_FILES" | wc -l)
          
          if [ -z "$STAGED_FILES" ] || [ "$STAGED_COUNT" -eq 0 ]; then
            echo "ERROR: No files were staged for commit"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi
          
          echo "Successfully staged $STAGED_COUNT files"
          echo "Sample of staged files:"
          echo "$STAGED_FILES" | head -20
          
          echo ""
          echo "=== Committing..."
          git commit -m "chore: Sync deployment files to HF Space (excludes test data to stay within storage limits)"
          echo "✓ Commit successful"

      - name: Add Hugging Face remote
        run: |
          git remote add huggingface https://huggingface.co/spaces/f007kht/osprey-experimental || true
          git remote set-url huggingface https://huggingface.co/spaces/f007kht/osprey-experimental

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.osprey_space_push }}
        run: |
          if [ -z "${HF_TOKEN}" ]; then
            echo "::error::HF_TOKEN environment variable is empty. Check that osprey_space_push secret is configured."
            echo ""
            echo "To configure:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: osprey_space_push (must use underscores, not hyphens)"
            echo "4. Value: Your Hugging Face token (starts with 'hf_')"
            echo "5. Click 'Add secret'"
            exit 1
          fi
          echo "Pushing to Hugging Face Space..."
          git push --force https://huggingface:${HF_TOKEN}@huggingface.co/spaces/f007kht/osprey-experimental hf-deploy-temp:main
          echo "✅ Successfully pushed to Hugging Face Space"

